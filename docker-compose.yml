services:
  app-cuda:
    profiles: ["cuda"]
    build:
      context: .
      dockerfile: containers/cuda/Dockerfile
    image: sdr_os-cuda
    volumes:
      - .:/workspace
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
    device_requests:
      - driver: nvidia
        count: -1
        capabilities: ["gpu"]
    shm_size: "2gb"

  app-rocm:
    profiles: ["rocm"]
    build:
      context: .
      dockerfile: containers/rocm/Dockerfile
    image: sdr_os-rocm
    volumes:
      - .:/workspace
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video
    security_opt:
      - seccomp=unconfined
    shm_size: "2gb"

  app-mlx:
    profiles: ["mlx"]
    build:
      context: .
      dockerfile: containers/mlx/Dockerfile
      args:
        MLX_VARIANT: mlx_cpu
    image: sdr_os-mlx
    volumes:
      - .:/workspace
    shm_size: "2gb"

  # ─── NATS Message Broker ────────────────────────────────
  nats:
    profiles: ["sim"]
    image: nats:2-alpine
    networks:
      - backplane
    expose:
      - "4222"
    healthcheck:
      test: ["CMD", "nats-server", "--signal", "ldm"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ─── Transport Server (Rust) ──────────────────────────────
  transport-server:
    profiles: ["sim"]
    build:
      context: services/transport-server
      dockerfile: Dockerfile
    image: sdr_os-transport
    networks:
      - backplane
    expose:
      - "8080"
    volumes:
      - sdr_ipc:/dev/shm/sdr_os_ipc:ro
    environment:
      - SDR_SHM_PATH=/dev/shm/sdr_os_ipc/frames
      - SDR_NATS_URL=nats://nats:4222
    depends_on:
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  backplane:
    driver: bridge

volumes:
  sdr_ipc:
