version: "3.9"

services:
  app-cuda:
    profiles: ["cuda"]
    build:
      context: .
      dockerfile: containers/cuda/Dockerfile
    image: sdr_os-cuda
    volumes:
      - .:/workspace
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
    device_requests:
      - driver: nvidia
        count: -1
        capabilities: ["gpu"]
    shm_size: "2gb"

  app-rocm:
    profiles: ["rocm"]
    build:
      context: .
      dockerfile: containers/rocm/Dockerfile
    image: sdr_os-rocm
    volumes:
      - .:/workspace
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video
    security_opt:
      - seccomp=unconfined
    shm_size: "2gb"

  app-mlx:
    profiles: ["mlx"]
    build:
      context: .
      dockerfile: containers/mlx/Dockerfile
      args:
        MLX_VARIANT: mlx_cpu
    image: sdr_os-mlx
    volumes:
      - .:/workspace
    shm_size: "2gb"
