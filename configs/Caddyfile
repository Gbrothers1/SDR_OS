# SDR_OS reverse proxy
# HTTP fallback for local dev; HTTPS via Tailscale certs when available

(sdr_routes) {
    @healthcheck path /health
    handle @healthcheck {
        log_skip
        respond "OK" 200
    }

    handle /stream/ws {
        reverse_proxy transport-server:8080 {
            flush_interval -1
            transport http {
                read_timeout 0
            }
        }
    }

    @socketio path /socket.io/*
    handle @socketio {
        reverse_proxy node:3000
    }

    handle /ros/* {
        reverse_proxy host.docker.internal:9090
    }

    handle /api/* {
        reverse_proxy node:3000
    }

    handle {
        root * /srv/www
        try_files {path} /index.html
        file_server
    }
}

# HTTP — local/dev fallback (no TLS certs required)
:80 {
    log {
        output stdout
        format console
        level INFO
    }
    import sdr_routes
}

# HTTPS — Tailscale secure context (for Safari Gamepad API etc.)
https://amd-rtx.tail09c99.ts.net {
    tls /etc/caddy/tls/amd-rtx.tail09c99.ts.net.crt /etc/caddy/tls/amd-rtx.tail09c99.ts.net.key
    log {
        output stdout
        format console
        level INFO
    }
    import sdr_routes
}
