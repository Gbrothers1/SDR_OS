name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - dev

jobs:
  # ──────────────── CPU CHECKS (every PR) ────────────────

  validate-compose:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate docker-compose.yml
        run: docker compose config --quiet

  lint-and-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install test deps
        run: pip install pytest
      - name: Unit tests
        run: PYTHONPATH=src pytest -v tests/unit/
        env:
          PYTHONPATH: src
      - name: Cross-language SHM protocol tests
        run: PYTHONPATH=src pytest -v tests/integration/test_shm_cross_language.py
        env:
          PYTHONPATH: src

  rust-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: services/transport-server
      - name: Transport server tests
        run: cargo test --manifest-path services/transport-server/Cargo.toml

  ros-jazzy-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build ROS2 Jazzy container
        run: docker compose --profile dev build ros-bridge
      - name: Verify ROS2 Jazzy
        run: |
          docker compose --profile dev run --rm ros-bridge bash -c \
            "source /opt/ros/jazzy/setup.bash \
             && echo ROS_DISTRO=\$ROS_DISTRO \
             && ros2 pkg list 2>/dev/null | grep rosbridge_server"

  docs-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install docs deps
        run: pip install mkdocs mkdocs-material mkdocs-git-revision-date-localized-plugin mike pymdown-extensions
      - name: Build docs
        run: mkdocs build

  # ──────────────── GPU SMOKE (self-hosted) ────────────────

  cuda-smoke:
    runs-on: [self-hosted, linux, gpu, nvidia]
    steps:
      - uses: actions/checkout@v4
      - name: Build CUDA container
        run: docker compose --profile cuda build app-cuda
      - name: NVENC validation
        run: docker compose --profile cuda run --rm app-cuda python3 scripts/validate_nvenc.py
      - name: CUDA smoke tests
        run: |
          if [ -d tests/smoke ]; then
            docker compose --profile cuda run --rm app-cuda pytest -q tests/smoke
          else
            echo "No smoke tests yet"
          fi

  rocm-smoke:
    runs-on: [self-hosted, linux, gpu, rocm]
    steps:
      - uses: actions/checkout@v4
      - name: ROCm smoke
        run: |
          if [ -d tests/smoke ]; then
            docker compose --profile rocm run --rm app-rocm pytest -q tests/smoke
          else
            echo "No smoke tests yet"
          fi

  mlx-smoke:
    runs-on: [self-hosted, macos, arm64, mlx]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: pip install uv
      - name: Sync deps (frozen)
        run: |
          if [ -f uv.lock ]; then uv sync --frozen --group mlx; fi
      - name: MLX smoke
        run: |
          if [ -d tests/smoke ]; then
            pytest -q tests/smoke
          else
            echo "No smoke tests yet"
          fi
